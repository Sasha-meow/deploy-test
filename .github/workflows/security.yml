# –ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞
name: security.yml

# –¢—Ä–∏–≥–≥–µ—Ä—ã –ø–∞–π–ø–ª–∞–π–Ω–∞
on:
  pull_request:
    types: [opened, synchronize, reopened]   # –ü—Ä–∏ –ø—É—à–µ –≤ main –∏–ª–∏ master –≤–µ—Ç–∫–∏

# –î–∂–æ–±—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ
jobs:
  # –î–∂–æ–±–∞ –±–∏–ª–¥–∞
  build:
    runs-on: ubuntu-latest
    name: üìä –î–∂–æ–±–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SBOM

    # –®–∞–≥–∏ –¥–∂–æ–±—ã –±–∏–ª–¥–∞
    steps:
      - name: üì• –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ –í–ú
        uses: actions/checkout@v4

      - name: ‚éî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm-–ø–∞–∫–µ—Ç–æ–≤
        run: npm ci

      - name: üèóÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SBOM (CycloneDX)
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json

      - name: ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ SBOM-–∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
        uses: actions/upload-artifact@v4
        with:
          name: security-artifacts
          path: sbom.json
          retention-days: 7

  # –î–∂–æ–±–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞
  security:
    runs-on: ubuntu-latest
    name: –î–∂–æ–±–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞
    needs: build    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SBOM
    steps:
      - name: üì• –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ –í–ú
        uses: actions/checkout@v4

      - name: ‚éî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm-–ø–∞–∫–µ—Ç–æ–≤
        run: npm ci

      - name: üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ SBOM
        uses: actions/download-artifact@v4
        with:
          name: security-artifacts
          path: .

      - name: üìä –ó–∞–ø—É—Å–∫ OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: '${{ github.event.repository.name }}'
          path: '.'
          format: 'HTML'
          out: 'reports'
          args: '--disableOssIndex --scan .'

      - name: ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–∞ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: reports/
          retention-days: 7
